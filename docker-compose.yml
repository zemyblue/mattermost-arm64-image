services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mmuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mmuser_password}
      POSTGRES_DB: ${POSTGRES_DB:-mattermost}
    volumes:
      - ${POSTGRES_DATA_PATH:-postgres_data}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mmuser} -d ${POSTGRES_DB:-mattermost}"]
      interval: 10s
      timeout: 5s
      retries: 5

  mattermost:
    image: ${MATTERMOST_IMAGE:-ghcr.io/zemyblue/mattermost-arm64:latest}
    restart: unless-stopped
    ports:
      - "${MATTERMOST_HTTP_PORT:-8065}:8065"
      - "${MATTERMOST_GOSSIP_PORT:-8067}:8067"
    environment:
      # 타임존 설정
      TZ: ${TIMEZONE:-Asia/Seoul}

      # PostgreSQL 연결 설정
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://${POSTGRES_USER:-mmuser}:${POSTGRES_PASSWORD:-mmuser_password}@postgres:5432/${POSTGRES_DB:-mattermost}?sslmode=disable&connect_timeout=10

      # 서버 설정
      MM_SERVICESETTINGS_SITEURL: ${MATTERMOST_SITE_URL:-http://localhost:8065}
      MM_SERVICESETTINGS_ENABLELOCALMODE: "true"

      # 파일 저장 설정
      MM_FILESETTINGS_DIRECTORY: /opt/mattermost/data
      MM_FILESETTINGS_MAXFILESIZE: ${MAX_FILE_SIZE:-104857600}

      # 플러그인 설정
      MM_PLUGINSETTINGS_DIRECTORY: /opt/mattermost/plugins
      MM_PLUGINSETTINGS_CLIENTDIRECTORY: /opt/mattermost/client/plugins

      # 이메일 설정
      MM_EMAILSETTINGS_ENABLESIGNUPWITHEMAIL: ${EMAIL_SIGNUP_ENABLED:-true}
      MM_EMAILSETTINGS_ENABLESIGNINWITHEMAIL: ${EMAIL_SIGNIN_ENABLED:-true}
      MM_EMAILSETTINGS_REQUIREEMAILVERIFICATION: ${EMAIL_VERIFICATION_REQUIRED:-false}
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: ${EMAIL_NOTIFICATIONS_ENABLED:-false}

      # SMTP 설정 (프로덕션 환경)
      MM_EMAILSETTINGS_SMTPUSERNAME: ${SMTP_USERNAME:-}
      MM_EMAILSETTINGS_SMTPPASSWORD: ${SMTP_PASSWORD:-}
      MM_EMAILSETTINGS_SMTPSERVER: ${SMTP_SERVER:-}
      MM_EMAILSETTINGS_SMTPPORT: ${SMTP_PORT:-587}
      MM_EMAILSETTINGS_ENABLESMTPAUTH: ${SMTP_AUTH_ENABLED:-false}
      MM_EMAILSETTINGS_FEEDBACKNAME: ${SMTP_FROM_NAME:-Mattermost}
      MM_EMAILSETTINGS_FEEDBACKEMAIL: ${SMTP_FROM_EMAIL:-}
      MM_EMAILSETTINGS_CONNECTIONSECURITY: ${SMTP_CONNECTION_SECURITY:-STARTTLS}

      # 푸시 알림 설정 (모바일 앱)
      MM_EMAILSETTINGS_SENDPUSHNOTIFICATIONS: ${SEND_PUSH_NOTIFICATIONS:-true}
      MM_EMAILSETTINGS_PUSHNOTIFICATIONSERVER: ${PUSH_NOTIFICATION_SERVER:-https://push-test.mattermost.com}
      MM_EMAILSETTINGS_PUSHNOTIFICATIONCONTENTS: ${PUSH_NOTIFICATION_CONTENTS:-full}

    volumes:
      - ${MATTERMOST_DATA_PATH:-mattermost_data}:/opt/mattermost/data
      - ${MATTERMOST_LOGS_PATH:-mattermost_logs}:/opt/mattermost/logs
      - ${MATTERMOST_CONFIG_PATH:-mattermost_config}:/opt/mattermost/config
      - ${MATTERMOST_PLUGINS_PATH:-mattermost_plugins}:/opt/mattermost/plugins
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Named volumes - VOLUME_TYPE을 bind로 설정하면 사용 안 함
volumes:
  postgres_data:
  mattermost_data:
  mattermost_logs:
  mattermost_config:
  mattermost_plugins:
